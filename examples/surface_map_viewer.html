<!DOCTYPE html>
<html>
<!-- 

Use surface_map.py to generate heightmap and texturemap for use with this tool.

-->
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Surface Map Heightmap Viewer</title>

        <!-- Babylon.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
        <script src="https://assets.babylonjs.com/generated/Assets.js"></script>
        <script src="https://cdn.babylonjs.com/recast.js"></script>
        <script src="https://cdn.babylonjs.com/ammo.js"></script>
        <script src="https://cdn.babylonjs.com/havok/HavokPhysics_umd.js"></script>
        <script src="https://cdn.babylonjs.com/cannon.js"></script>
        <script src="https://cdn.babylonjs.com/Oimo.js"></script>
        <script src="https://cdn.babylonjs.com/earcut.min.js"></script>
        <script src="https://cdn.babylonjs.com/babylon.js"></script>
        <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
        <script src="https://cdn.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
        <script src="https://cdn.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
        <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.js"></script>
        <script src="https://cdn.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
        <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
        <script src="https://cdn.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>

        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                font-family: Arial, sans-serif;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }

            #canvasZone {
                width: 100%;
                height: 100%;
                display: none;
            }

            #fileSelector {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                gap: 20px;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                color: white;
            }

            #fileSelector h1 {
                margin-bottom: 10px;
                font-size: 2em;
            }

            #fileSelector p {
                color: #aaa;
                margin-bottom: 20px;
            }

            .file-input-group {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                padding: 20px;
                border: 2px dashed #444;
                border-radius: 10px;
                background: rgba(255,255,255,0.05);
                min-width: 300px;
            }

            .file-input-group label {
                font-weight: bold;
                font-size: 1.1em;
            }

            .file-input-group input[type="file"] {
                padding: 10px;
                cursor: pointer;
            }

            .file-input-group .preview {
                max-width: 200px;
                max-height: 150px;
                border: 1px solid #555;
                display: none;
            }

            .file-input-group.loaded {
                border-color: #4CAF50;
            }

            #loadButton {
                padding: 15px 40px;
                font-size: 1.2em;
                background: #4CAF50;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 20px;
                transition: background 0.3s;
            }

            #loadButton:hover:not(:disabled) {
                background: #45a049;
            }

            #loadButton:disabled {
                background: #666;
                cursor: not-allowed;
            }

            .settings-group {
                display: flex;
                gap: 20px;
                margin-top: 10px;
            }

            .settings-group label {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }

            .settings-group input[type="number"] {
                padding: 8px;
                border-radius: 4px;
                border: 1px solid #444;
                background: #2a2a3e;
                color: white;
                width: 100px;
            }

            #status {
                color: #aaa;
                font-style: italic;
            }

            #controlPanel {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                background: rgba(20, 20, 40, 0.9);
                padding: 10px 20px;
                display: none;
                flex-wrap: wrap;
                gap: 15px;
                align-items: center;
                z-index: 100;
                border-bottom: 2px solid #444;
            }

            #controlPanel .control-item {
                display: flex;
                align-items: center;
                gap: 8px;
                color: white;
                font-size: 0.9em;
            }

            #controlPanel .control-item label {
                min-width: 100px;
            }

            #controlPanel .control-item input[type="range"] {
                width: 120px;
                cursor: pointer;
            }

            #controlPanel .control-item .value-display {
                min-width: 50px;
                text-align: right;
                font-family: monospace;
                color: #4CAF50;
            }

            #controlPanel .control-item input[type="checkbox"] {
                width: 18px;
                height: 18px;
                cursor: pointer;
            }

            #controlPanel #rebuildBtn {
                padding: 6px 15px;
                background: #2196F3;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9em;
            }

            #controlPanel #rebuildBtn:hover {
                background: #1976D2;
            }

            #controlPanel .separator {
                width: 1px;
                height: 30px;
                background: #444;
            }
        </style>
    </head>
<body>
    <div id="fileSelector">
        <h1>üó∫Ô∏è Surface Map Heightmap Viewer</h1>
        <p>Load the PNG files generated by surface_map.py to view them in 3D</p>
        
        <div class="file-input-group" id="textureGroup">
            <label>Surface Map (texture)</label>
            <input type="file" id="textureFile" accept="image/png">
            <img class="preview" id="texturePreview">
        </div>
        
        <div class="file-input-group" id="heightmapGroup">
            <label>Heightmap</label>
            <input type="file" id="heightmapFile" accept="image/png">
            <img class="preview" id="heightmapPreview">
        </div>

        <div class="settings-group">
            <label>
                Height Scale
                <input type="number" id="heightScale" value="10" min="1" max="100">
                Might have to be increased<br>for tiny maps
            </label>
            <label>
                Subdivisions
                <input type="number" id="subdivisions" value="1000" min="10" max="10000">
            </label>
        </div>

        <div class="settings-group">
            <label>
                <input type="checkbox" id="enableWater" checked> Enable Water Layer
            </label>
            <label>
                Water Level (Y)
                <input type="number" id="waterLevel" value="4.1" min="0" max="10" step="0.1">
                Try something around 4.1<br>for worldgen V1
            </label>
            <label>
                Water Opacity
                <input type="number" id="waterOpacity" value="0.6" min="0.1" max="1" step="0.1">
            </label>
        </div>

        <button id="loadButton" disabled>Load 3D View</button>
        <p id="status">Please select both images</p>
    </div>

    <div id="canvasZone"><canvas id="renderCanvas"></canvas></div>
    
    <div id="controlPanel">
        <div class="control-item">
            <label>Height Scale:</label>
            <input type="range" id="heightScaleSlider" min="1" max="100" value="10">
            <span class="value-display" id="heightScaleValue">10</span>
        </div>
        <div class="control-item">
            <label>Subdivisions:</label>
            <input type="range" id="subdivisionsSlider" min="50" max="10000" step="10" value="1000">
            <span class="value-display" id="subdivisionsValue">1000</span>
        </div>
        <div class="control-item">
            <button id="rebuildBtn">Rebuild Terrain</button>
        </div>
        <div class="separator"></div>
        <div class="control-item">
            <input type="checkbox" id="enableWaterSlider" checked>
            <label>Water</label>
        </div>
        <div class="control-item">
            <label>Water Level:</label>
            <input type="range" id="waterLevelSlider" min="0" max="10" step="0.1" value="4.1">
            <span class="value-display" id="waterLevelValue">4.1</span>
        </div>
        <div class="control-item">
            <label>Water Opacity:</label>
            <input type="range" id="waterOpacitySlider" min="0.1" max="1" step="0.05" value="0.6">
            <span class="value-display" id="waterOpacityValue">0.6</span>
        </div>
        <div class="separator"></div>
        <div class="control-item">
            <label>Sun Speed:</label>
            <input type="range" id="sunSpeedSlider" min="0" max="0.5" step="0.01" value="0.1">
            <span class="value-display" id="sunSpeedValue">0.1</span>
        </div>
    </div>
    
    <script>
        var canvas = document.getElementById("renderCanvas");
        var sun_direction = 1;
        var sun_speed = 0.1;
        var engine = null;
        var scene = null;
        var sceneToRender = null;
        var waterMesh = null;
        var waterMat = null;
        var groundMesh = null;
        var groundWidth = 200;
        var groundHeight = 200;

        // File handling
        var textureDataUrl = null;
        var heightmapDataUrl = null;
        var imageWidth = 0;
        var imageHeight = 0;

        // Sync sliders with initial form values
        function syncSlidersFromForm() {
            document.getElementById('heightScaleSlider').value = document.getElementById('heightScale').value;
            document.getElementById('heightScaleValue').textContent = document.getElementById('heightScale').value;
            
            document.getElementById('subdivisionsSlider').value = document.getElementById('subdivisions').value;
            document.getElementById('subdivisionsValue').textContent = document.getElementById('subdivisions').value;
            
            document.getElementById('enableWaterSlider').checked = document.getElementById('enableWater').checked;
            
            document.getElementById('waterLevelSlider').value = document.getElementById('waterLevel').value;
            document.getElementById('waterLevelValue').textContent = document.getElementById('waterLevel').value;
            
            document.getElementById('waterOpacitySlider').value = document.getElementById('waterOpacity').value;
            document.getElementById('waterOpacityValue').textContent = document.getElementById('waterOpacity').value;
        }

        // Setup slider event listeners
        function setupSliderControls() {
            // Height Scale slider (requires rebuild)
            document.getElementById('heightScaleSlider').addEventListener('input', function() {
                document.getElementById('heightScaleValue').textContent = this.value;
            });

            // Subdivisions slider (requires rebuild)
            document.getElementById('subdivisionsSlider').addEventListener('input', function() {
                document.getElementById('subdivisionsValue').textContent = this.value;
            });

            // Rebuild button
            document.getElementById('rebuildBtn').addEventListener('click', function() {
                rebuildTerrain();
            });

            // Water enable checkbox (real-time)
            document.getElementById('enableWaterSlider').addEventListener('change', function() {
                if (waterMesh) {
                    waterMesh.setEnabled(this.checked);
                } else if (this.checked) {
                    createWater();
                }
            });

            // Water Level slider (real-time)
            document.getElementById('waterLevelSlider').addEventListener('input', function() {
                document.getElementById('waterLevelValue').textContent = this.value;
                if (waterMesh) {
                    waterMesh.position.y = parseFloat(this.value);
                }
            });

            // Water Opacity slider (real-time)
            document.getElementById('waterOpacitySlider').addEventListener('input', function() {
                document.getElementById('waterOpacityValue').textContent = this.value;
                if (waterMat) {
                    waterMat.alpha = parseFloat(this.value);
                }
            });

            // Sun Speed slider (real-time)
            document.getElementById('sunSpeedSlider').addEventListener('input', function() {
                document.getElementById('sunSpeedValue').textContent = this.value;
                sun_speed = parseFloat(this.value);
            });
        }

        function createWater() {
            if (!scene) return;
            
            const waterLevel = parseFloat(document.getElementById('waterLevelSlider').value) || 4.1;
            const waterOpacity = parseFloat(document.getElementById('waterOpacitySlider').value) || 0.6;

            waterMesh = BABYLON.MeshBuilder.CreateGround("water", {
                width: groundWidth * 1.5,
                height: groundHeight * 1.5
            }, scene);
            waterMesh.position.y = waterLevel;

            waterMat = new BABYLON.StandardMaterial("waterMaterial", scene);
            waterMat.diffuseColor = new BABYLON.Color3(0.2, 0.5, 0.8);
            waterMat.specularColor = new BABYLON.Color3(0.3, 0.3, 0.3);
            waterMat.emissiveColor = new BABYLON.Color3(0.1, 0.2, 0.4);
            waterMat.alpha = waterOpacity;
            waterMat.backFaceCulling = false;
            waterMesh.material = waterMat;
        }

        function rebuildTerrain() {
            if (!scene) return;
            
            const heightScale = parseFloat(document.getElementById('heightScaleSlider').value) || 10;
            const subdivisions = parseInt(document.getElementById('subdivisionsSlider').value) || 250;

            // Remove old ground
            if (groundMesh) {
                groundMesh.dispose();
            }

            // Ground material with surface texture
            var groundMaterial = new BABYLON.StandardMaterial("ground", scene);
            groundMaterial.diffuseTexture = new BABYLON.Texture(textureDataUrl, scene);

            // Create ground from heightmap
            groundMesh = BABYLON.MeshBuilder.CreateGroundFromHeightMap("ground", heightmapDataUrl, {
                width: groundWidth,
                height: groundHeight,
                subdivisions: subdivisions,
                minHeight: 0,
                maxHeight: heightScale,
                onReady: function(mesh) {
                    mesh.material = groundMaterial;
                }
            }, scene);
        }

        setupSliderControls();

        function updateLoadButton() {
            const loadButton = document.getElementById('loadButton');
            const status = document.getElementById('status');
            
            if (textureDataUrl && heightmapDataUrl) {
                loadButton.disabled = false;
                status.textContent = `Ready to load (${imageWidth}x${imageHeight} pixels)`;
            } else {
                loadButton.disabled = true;
                const missing = [];
                if (!textureDataUrl) missing.push('surface map');
                if (!heightmapDataUrl) missing.push('heightmap');
                status.textContent = `Please select: ${missing.join(', ')}`;
            }
        }

        function handleFileSelect(inputId, previewId, groupId, isHeightmap) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const group = document.getElementById(groupId);
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const dataUrl = event.target.result;
                        preview.src = dataUrl;
                        preview.style.display = 'block';
                        group.classList.add('loaded');
                        
                        // Get image dimensions
                        const img = new Image();
                        img.onload = function() {
                            if (isHeightmap) {
                                heightmapDataUrl = dataUrl;
                                imageWidth = img.width;
                                imageHeight = img.height;
                            } else {
                                textureDataUrl = dataUrl;
                            }
                            updateLoadButton();
                        };
                        img.src = dataUrl;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Setup file inputs
        handleFileSelect('textureFile', 'texturePreview', 'textureGroup', false);
        handleFileSelect('heightmapFile', 'heightmapPreview', 'heightmapGroup', true);

        // Load button handler
        document.getElementById('loadButton').addEventListener('click', function() {
            syncSlidersFromForm();
            document.getElementById('fileSelector').style.display = 'none';
            document.getElementById('canvasZone').style.display = 'block';
            document.getElementById('controlPanel').style.display = 'flex';
            initScene();
        });

        var startRenderLoop = function (engine, canvas) {
            engine.runRenderLoop(function () {
                if (sceneToRender && sceneToRender.activeCamera) {
                    sceneToRender.render();
                }
            });
        }

        var createDefaultEngine = function() { 
            return new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true, disableWebGL2Support: false}); 
        };

        var createScene = function () {
            var sceneLocal = new BABYLON.Scene(engine);

            const heightScale = parseFloat(document.getElementById('heightScaleSlider').value) || 10;
            const subdivisions = parseInt(document.getElementById('subdivisionsSlider').value) || 250;

            // Calculate ground size based on aspect ratio
            const aspectRatio = imageWidth / imageHeight;
            const baseSize = 200;
            groundWidth = aspectRatio >= 1 ? baseSize : baseSize * aspectRatio;
            groundHeight = aspectRatio >= 1 ? baseSize / aspectRatio : baseSize;

            // Light
            var spot = new BABYLON.PointLight("spot", new BABYLON.Vector3(0, 60, 10), sceneLocal);
            spot.diffuse = new BABYLON.Color3(1, 1, 1);
            spot.specular = new BABYLON.Color3(0, 0, 0);

            // Add hemisphere light for ambient lighting
            var hemiLight = new BABYLON.HemisphericLight("hemiLight", new BABYLON.Vector3(0, 1, 0), sceneLocal);
            hemiLight.intensity = 0.5;

            // Camera
            var camera = new BABYLON.ArcRotateCamera("Camera", 0, 0.8, 150, BABYLON.Vector3.Zero(), sceneLocal);
            camera.lowerBetaLimit = 0.1;
            camera.upperBetaLimit = (Math.PI / 2) * 0.95;
            camera.lowerRadiusLimit = 20;
            camera.upperRadiusLimit = 500;
            camera.attachControl(canvas, true);

            // Ground material with surface texture
            var groundMaterial = new BABYLON.StandardMaterial("ground", sceneLocal);
            groundMaterial.diffuseTexture = new BABYLON.Texture(textureDataUrl, sceneLocal);

            // Create ground from heightmap
            groundMesh = BABYLON.MeshBuilder.CreateGroundFromHeightMap("ground", heightmapDataUrl, {
                width: groundWidth,
                height: groundHeight,
                subdivisions: subdivisions,
                minHeight: 0,
                maxHeight: heightScale,
                onReady: function(mesh) {
                    mesh.material = groundMaterial;
                    // Center the camera target on the ground
                    camera.target = mesh.getBoundingInfo().boundingBox.centerWorld;
                }
            }, sceneLocal);

            // Sphere to see the light's position
            var sun = BABYLON.Mesh.CreateSphere("sun", 10, 4, sceneLocal);
            sun.material = new BABYLON.StandardMaterial("sun", sceneLocal);
            sun.material.emissiveColor = new BABYLON.Color3(1, 1, 0);

            // Skybox
            var skybox = BABYLON.MeshBuilder.CreateBox("skyBox", {size: 1000}, sceneLocal);
            var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", sceneLocal);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0.5, 0.7, 0.9);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.emissiveColor = new BABYLON.Color3(0.4, 0.6, 0.8);
            skyboxMaterial.disableLighting = true;
            skybox.material = skyboxMaterial;

            // Water layer
            const enableWater = document.getElementById('enableWaterSlider').checked;
            const waterLevel = parseFloat(document.getElementById('waterLevelSlider').value) || 4.1;
            const waterOpacity = parseFloat(document.getElementById('waterOpacitySlider').value) || 0.6;

            if (enableWater) {
                waterMesh = BABYLON.MeshBuilder.CreateGround("water", {
                    width: groundWidth * 1.5,
                    height: groundHeight * 1.5
                }, sceneLocal);
                waterMesh.position.y = waterLevel;

                waterMat = new BABYLON.StandardMaterial("waterMaterial", sceneLocal);
                waterMat.diffuseColor = new BABYLON.Color3(0.2, 0.5, 0.8);
                waterMat.specularColor = new BABYLON.Color3(0.3, 0.3, 0.3);
                waterMat.emissiveColor = new BABYLON.Color3(0.1, 0.2, 0.4);
                waterMat.alpha = waterOpacity;
                waterMat.backFaceCulling = false;
                waterMesh.material = waterMat;
            }

            // Sun animation
            sceneLocal.registerBeforeRender(function () {
                sun.position = spot.position;
                spot.position.x -= sun_direction * sun_speed;

                if (spot.position.x < -80) {
                    sun_direction = -1;
                    spot.position.x = -80;
                }
                if (spot.position.x > 80) {
                    sun_direction = 1;
                    spot.position.x = 80;
                }
            });

            return sceneLocal;
        }

        async function initScene() {
            try {
                window.engine = createDefaultEngine();
                if (!engine) throw 'engine should not be null.';
                startRenderLoop(engine, canvas);
                window.scene = createScene();
                sceneToRender = scene;
            } catch(e) {
                console.error("Error initializing scene:", e);
            }
        }

        // Resize
        window.addEventListener("resize", function () {
            if (engine) {
                engine.resize();
            }
        });
    </script>
</body>
</html>
